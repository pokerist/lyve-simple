<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HikCentral Middleware Admin</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --border-radius: 8px;
            --box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .error-message {
            color: var(--danger-color);
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }

        /* Dashboard Styles */
        .dashboard-header {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-header h1 {
            color: var(--dark-color);
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background-color: var(--danger-color);
        }

        .logout-btn:hover {
            background-color: #c82333;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .card h3 {
            margin-bottom: 15px;
            color: var(--dark-color);
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 10px;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status-active { color: var(--success-color); font-weight: bold; }
        .status-inactive { color: var(--warning-color); font-weight: bold; }
        .status-deleted { color: var(--danger-color); font-weight: bold; text-decoration: line-through; }

        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group-full {
            grid-column: 1 / -1;
        }

        .required::before {
            content: "* ";
            color: var(--danger-color);
            font-weight: bold;
        }

        .form-help {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            display: block;
        }

        .field-error {
            border-color: var(--danger-color) !important;
            background-color: #f8d7da !important;
        }

        .error-message {
            color: var(--danger-color);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        /* Button Styles */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* Response Container */
        .response-container {
            margin-top: 20px;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            overflow: hidden;
            display: none;
        }

        .response-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .response-body {
            padding: 15px;
            background: #f8f9fa;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .json-key { color: var(--primary-color); }
        .json-string { color: var(--success-color); }
        .json-number { color: #6f42c1; }
        .json-boolean { color: var(--warning-color); }
        .json-null { color: var(--secondary-color); }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 20px;
            background: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            overflow: hidden;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s ease;
            border-right: 1px solid #dee2e6;
        }

        .tab-btn:last-child {
            border-right: none;
        }

        .tab-btn:hover {
            background: #e9ecef;
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            border-bottom: 3px solid var(--primary-color);
        }

        .tab-content {
            display: none;
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            padding: 20px;
            min-height: 400px;
        }

        .tab-content.active {
            display: block;
        }

        /* Loading */
        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--primary-color);
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
            background: #d4edda;
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
            background: #f8d7da;
        }

        .toast.info {
            border-left: 4px solid var(--primary-color);
            background: #d1ecf1;
        }

        .toast-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginForm" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>üîê Admin Login</h1>
                <p>HikCentral Middleware</p>
            </div>
            <form id="loginFormElement">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" placeholder="Enter password" required>
                </div>
                <div id="loginError" class="error-message"></div>
                <button type="submit" class="btn">
                    <span class="spinner" id="loginSpinner" style="display: none;"></span>
                    Login
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display: none;">
        <div class="dashboard-header">
            <h1>üõ°Ô∏è Admin Dashboard</h1>
            <div class="user-info">
                <span id="currentUser">Admin</span>
                <button class="btn btn-secondary logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Residents Management -->
            <div class="card">
                <h3>üë• Residents Management</h3>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="searchEmail" placeholder="Search by email..." style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 300px;">
                    <button onclick="loadResidents()" class="btn btn-small" style="margin-left: 10px;">Search</button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="residentsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Type</th>
                                <th>HikCentral ID</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Manual Operations -->
            <div class="card">
                <h3>‚öôÔ∏è Manual Operations</h3>
                
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('create-resident')">üè† Create Resident</button>
                    <button class="tab-btn" onclick="switchTab('get-identity')">üîë Get Identity</button>
                    <button class="tab-btn" onclick="switchTab('visitor-qr')">üë§ Visitor QR</button>
                    <button class="tab-btn" onclick="switchTab('delete-resident')">üóëÔ∏è Delete Resident</button>
                    <button class="tab-btn" onclick="switchTab('config')">‚öôÔ∏è Configuration</button>
                    <button class="tab-btn" onclick="switchTab('logs')">üìä Logs</button>
                </div>

                <!-- Create Resident Tab -->
                <div id="create-resident" class="tab-content active">
                    <div style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 6px; padding: 15px; margin-bottom: 20px;">
                        <strong>üìù Create New Resident:</strong> Fill in the required information to create a new resident in both the local database and HikCentral system.
                    </div>
                    
                    <form id="createResidentForm">
                        <div class="form-row">
                            <div class="form-group required">
                                <label>Name</label>
                                <input type="text" id="createName" placeholder="Enter full name">
                                <span class="form-help">This will be split into family name and given name for HikCentral</span>
                                <span class="error-message" id="nameError">Please enter a valid name</span>
                            </div>
                            <div class="form-group required">
                                <label>Email Address</label>
                                <input type="email" id="createEmail" placeholder="resident@example.com">
                                <span class="form-help">Must be a valid email address</span>
                                <span class="error-message" id="emailError">Please enter a valid email address</span>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="tel" id="createPhone" placeholder="+1234567890">
                                <span class="form-help">Optional - for contact purposes</span>
                                <span class="error-message" id="phoneError">Please enter a valid phone number</span>
                            </div>
                            <div class="form-group required">
                                <label>Community</label>
                                <input type="text" id="createCommunity" placeholder="GreenHills">
                                <span class="form-help">Community identifier for organization</span>
                                <span class="error-message" id="communityError">Please enter community name</span>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group required">
                                <label>Owner Type</label>
                                <select id="createType">
                                    <option value="resident">Resident</option>
                                    <option value="tenant">Tenant</option>
                                    <option value="family_member">Family Member</option>
                                    <option value="staff">Staff</option>
                                    <option value="visitor">Visitor</option>
                                </select>
                                <span class="form-help">Type of access and permissions</span>
                            </div>
                            <div class="form-group required">
                                <label>Unit ID</label>
                                <input type="text" id="createUnitId" placeholder="U1001">
                                <span class="form-help">Unique identifier for the unit</span>
                                <span class="error-message" id="unitIdError">Please enter unit ID</span>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group required">
                                <label>Valid From</label>
                                <input type="date" id="createFrom">
                                <span class="form-help">Start date for access permissions</span>
                                <span class="error-message" id="fromError">Please select a valid start date</span>
                            </div>
                            <div class="form-group required">
                                <label>Valid To</label>
                                <input type="date" id="createTo">
                                <span class="form-help">End date for access permissions (max 10 years)</span>
                                <span class="error-message" id="toError">Please select a valid end date</span>
                            </div>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn">
                                <span class="spinner" id="createSpinner" style="display: none;"></span>
                                üè† Create Resident
                            </button>
                        </div>
                    </form>

                    <div id="createResponseContainer" class="response-container">
                        <div class="response-header">
                            <span>üìã Create Resident Response</span>
                            <div>
                                <button class="btn-secondary btn-small" onclick="copyResponse('create')">üìã Copy</button>
                                <button class="btn-secondary btn-small" onclick="clearResponse('create')">üóëÔ∏è Clear</button>
                            </div>
                        </div>
                        <div id="createResponseBody" class="response-body"></div>
                    </div>
                </div>

                <!-- Get Identity Tab -->
                <div id="get-identity" class="tab-content">
                    <div style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 6px; padding: 15px; margin-bottom: 20px;">
                        <strong>üîë Get Resident Identity:</strong> Retrieve a resident's dynamic QR code for access. Requires resident to be synced with HikCentral.
                    </div>
                    
                    <form id="getIdentityForm">
                        <div class="form-row">
                            <div class="form-group required">
                                <label>Owner ID</label>
                                <input type="text" id="getIdOwnerId" placeholder="123">
                                <span class="form-help">The unique identifier for the resident</span>
                                <span class="error-message" id="getIdOwnerIdError">Please enter owner ID</span>
                            </div>
                            <div class="form-group">
                                <label>Unit ID</label>
                                <input type="text" id="getIdUnitId" placeholder="U1001">
                                <span class="form-help">Optional - unit identifier</span>
                            </div>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn">
                                <span class="spinner" id="getIdentitySpinner" style="display: none;"></span>
                                üîë Get Identity
                            </button>
                        </div>
                    </form>

                    <div id="identityResponseContainer" class="response-container">
                        <div class="response-header">
                            <span>üîë Identity Response</span>
                            <div>
                                <button class="btn-secondary btn-small" onclick="copyResponse('identity')">üìã Copy</button>
                                <button class="btn-secondary btn-small" onclick="clearResponse('identity')">üóëÔ∏è Clear</button>
                            </div>
                        </div>
                        <div id="identityResponseBody" class="response-body"></div>
                    </div>
                </div>

                <!-- Visitor QR Tab -->
                <div id="visitor-qr" class="tab-content">
                    <div style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 6px; padding: 15px; margin-bottom: 20px;">
                        <strong>üë§ Generate Visitor QR:</strong> Create a temporary QR code for visitors. Requires resident to be synced with HikCentral.
                    </div>
                    
                    <form id="getVisitorQRForm">
                        <div class="form-row">
                            <div class="form-group required">
                                <label>Owner ID</label>
                                <input type="text" id="getVisitorOwnerId" placeholder="123">
                                <span class="form-help">The resident who is hosting the visitor</span>
                                <span class="error-message" id="getVisitorOwnerIdError">Please enter owner ID</span>
                            </div>
                            <div class="form-group required">
                                <label>Unit ID</label>
                                <input type="text" id="getVisitorUnitId" placeholder="U1001">
                                <span class="form-help">Unit where visitor will be granted access</span>
                                <span class="error-message" id="getVisitorUnitIdError">Please enter unit ID</span>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group required">
                                <label>Visitor Name</label>
                                <input type="text" id="getVisitorName" placeholder="Jane Smith">
                                <span class="form-help">Full name of the visitor</span>
                                <span class="error-message" id="getVisitorNameError">Please enter visitor name</span>
                            </div>
                            <div class="form-group required">
                                <label>Visit Date</label>
                                <input type="date" id="getVisitorDate">
                                <span class="form-help">Date of the visit</span>
                                <span class="error-message" id="getVisitorDateError">Please select a visit date</span>
                            </div>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn">
                                <span class="spinner" id="getVisitorSpinner" style="display: none;"></span>
                                üë§ Get Visitor QR
                            </button>
                        </div>
                    </form>

                    <div id="visitorResponseContainer" class="response-container">
                        <div class="response-header">
                            <span>üë§ Visitor QR Response</span>
                            <div>
                                <button class="btn-secondary btn-small" onclick="copyResponse('visitor')">üìã Copy</button>
                                <button class="btn-secondary btn-small" onclick="clearResponse('visitor')">üóëÔ∏è Clear</button>
                            </div>
                        </div>
                        <div id="visitorResponseBody" class="response-body"></div>
                    </div>
                </div>

                <!-- Delete Resident Tab -->
                <div id="delete-resident" class="tab-content">
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 15px; margin-bottom: 20px;">
                        <strong>‚ö†Ô∏è Warning:</strong> This operation will soft delete the resident from the local database and attempt to remove them from HikCentral. The resident will be marked as "deleted" but their data will remain in the system for audit purposes.
                    </div>
                    
                    <form id="deleteResidentForm">
                        <div class="form-row">
                            <div class="form-group required">
                                <label>Owner ID</label>
                                <input type="text" id="deleteOwnerId" placeholder="123">
                                <span class="form-help">The unique identifier for the resident to delete</span>
                                <span class="error-message" id="deleteOwnerIdError">Please enter owner ID</span>
                            </div>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn" style="background-color: var(--danger-color);">
                                <span class="spinner" id="deleteSpinner" style="display: none;"></span>
                                üóëÔ∏è Delete Resident
                            </button>
                        </div>
                    </form>

                    <div id="deleteResponseContainer" class="response-container">
                        <div class="response-header">
                            <span>üóëÔ∏è Delete Resident Response</span>
                            <div>
                                <button class="btn-secondary btn-small" onclick="copyResponse('delete')">üìã Copy</button>
                                <button class="btn-secondary btn-small" onclick="clearResponse('delete')">üóëÔ∏è Clear</button>
                            </div>
                        </div>
                        <div id="deleteResponseBody" class="response-body"></div>
                    </div>
                </div>

                <!-- Configuration Tab -->
                <div id="config" class="tab-content">
                    <div style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 6px; padding: 15px; margin-bottom: 20px;">
                        <strong>‚öôÔ∏è Configuration Management:</strong> Manage application configuration settings. Changes are applied immediately and persist across restarts.
                    </div>

                    <div class="btn-group">
                        <button class="btn" onclick="loadConfig()">üîÑ Load Configuration</button>
                        <button class="btn btn-secondary" onclick="changePassword()">üîê Change Password</button>
                    </div>

                    <div id="configList" style="margin-top: 20px; display: none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="configTableBody"></tbody>
                        </table>
                    </div>

                    <div id="configResponseContainer" class="response-container">
                        <div class="response-header">
                            <span>‚öôÔ∏è Configuration Response</span>
                            <div>
                                <button class="btn-secondary btn-small" onclick="copyResponse('config')">üìã Copy</button>
                                <button class="btn-secondary btn-small" onclick="clearResponse('config')">üóëÔ∏è Clear</button>
                            </div>
                        </div>
                        <div id="configResponseBody" class="response-body"></div>
                    </div>
                </div>

                <!-- Logs Tab -->
                <div id="logs" class="tab-content">
                    <div style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 6px; padding: 15px; margin-bottom: 20px;">
                        <strong>üìä API Logs:</strong> View recent API request logs for monitoring and debugging.
                    </div>

                    <div class="btn-group">
                        <button class="btn" onclick="loadLogs()">üîÑ Load Logs</button>
                        <button class="btn btn-secondary" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
                    </div>

                    <div style="margin-top: 20px;">
                        <label>Limit: </label>
                        <input type="number" id="logsLimit" value="100" min="1" max="1000" style="width: 100px; padding: 5px;">
                        <button class="btn btn-small" onclick="loadLogs()">Apply</button>
                    </div>

                    <div id="logsList" style="margin-top: 20px; display: none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Method</th>
                                    <th>URL</th>
                                    <th>Status</th>
                                    <th>Response Time</th>
                                    <th>IP</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody"></tbody>
                        </table>
                    </div>

                    <div id="logsResponseContainer" class="response-container">
                        <div class="response-header">
                            <span>üìä Logs Response</span>
                            <div>
                                <button class="btn-secondary btn-small" onclick="copyResponse('logs')">üìã Copy</button>
                                <button class="btn-secondary btn-small" onclick="clearResponse('logs')">üóëÔ∏è Clear</button>
                            </div>
                        </div>
                        <div id="logsResponseBody" class="response-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <script>
        // Global variables
        let currentUser = null;
        let sessionToken = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            
            // Form event listeners
            document.getElementById('loginFormElement').addEventListener('submit', handleLogin);
            document.getElementById('createResidentForm').addEventListener('submit', handleCreateResident);
            document.getElementById('getIdentityForm').addEventListener('submit', handleGetIdentity);
            document.getElementById('getVisitorQRForm').addEventListener('submit', handleGetVisitorQR);
            document.getElementById('deleteResidentForm').addEventListener('submit', handleDeleteResident);
        });

        // Authentication Functions
        function checkAuth() {
            const token = getCookie('sessionToken');
            if (token) {
                validateSession(token);
            } else {
                showLogin();
            }
        }

        function validateSession(token) {
            fetch('/admin/health', {
                headers: {
                    'X-Session-Token': token
                }
            })
            .then(response => {
                if (response.ok) {
                    sessionToken = token;
                    showDashboard();
                    loadResidents();
                } else {
                    showLogin();
                }
            })
            .catch(() => {
                showLogin();
            });
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const spinner = document.getElementById('loginSpinner');
            const errorDiv = document.getElementById('loginError');

            // Show loading
            spinner.style.display = 'inline-block';
            errorDiv.style.display = 'none';

            fetch('/admin/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sessionToken = data.expiresAt;
                    currentUser = 'admin';
                    showDashboard();
                    showToast('Login successful!', 'success');
                } else {
                    errorDiv.textContent = data.message || 'Login failed';
                    errorDiv.style.display = 'block';
                }
            })
            .catch(error => {
                errorDiv.textContent = 'Network error: ' + error.message;
                errorDiv.style.display = 'block';
            })
            .finally(() => {
                spinner.style.display = 'none';
            });
        }

        function logout() {
            fetch('/admin/logout', {
                method: 'POST',
                headers: {
                    'X-Session-Token': sessionToken
                }
            })
            .then(() => {
                sessionToken = null;
                currentUser = null;
                showLogin();
                showToast('Logged out successfully', 'info');
            });
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Dashboard Functions
        function showLogin() {
            document.getElementById('loginForm').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('currentUser').textContent = currentUser || 'Admin';
        }

        // Tab Management
        function switchTab(tabId) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabId).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // API Functions
        function loadResidents() {
            fetch('/residents', {
                headers: {
                    'X-Session-Token': sessionToken
                }
            })
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#residentsTable tbody');
                tbody.innerHTML = '';
                
                if (Array.isArray(data)) {
                    data.forEach(resident => {
                        const row = document.createElement('tr');
                        const personIdDisplay = resident.personId ? resident.personId : 'Not Synced';
                        const statusClass = resident.synced ? 'status-active' : 'status-inactive';
                        const statusText = resident.synced ? 'Synced' : 'Not Synced';
                        
                        row.innerHTML = `
                            <td>${resident.ownerId}</td>
                            <td>${resident.name}</td>
                            <td>${resident.email}</td>
                            <td>${resident.phone || '-'}</td>
                            <td>${resident.type}</td>
                            <td>${personIdDisplay}</td>
                            <td><span class="${statusClass}">${statusText}</span></td>
                            <td>
                                <button class="btn btn-small" onclick="viewDetails('${resident.ownerId}')">View</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            })
            .catch(error => {
                showToast('Error loading residents: ' + error.message, 'error');
            });
        }

        function handleCreateResident(e) {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('createName').value.trim(),
                email: document.getElementById('createEmail').value.trim(),
                phone: document.getElementById('createPhone').value.trim(),
                community: document.getElementById('createCommunity').value.trim(),
                from: document.getElementById('createFrom').value,
                to: document.getElementById('createTo').value,
                type: document.getElementById('createType').value,
                unitId: document.getElementById('createUnitId').value.trim()
            };

            // Validation
            if (!validateCreateForm()) return;

            const spinner = document.getElementById('createSpinner');
            spinner.style.display = 'inline-block';

            fetch('/residents', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Session-Token': sessionToken
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success || result.ownerId) {
                    showToast('Resident created successfully!', 'success');
                    loadResidents();
                    showResponse('create', result);
                } else {
                    showResponse('create', result);
                    showToast('Error creating resident: ' + (result.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showToast('Network error: ' + error.message, 'error');
            })
            .finally(() => {
                spinner.style.display = 'none';
            });
        }

        function handleGetIdentity(e) {
            e.preventDefault();
            
            const unitId = document.getElementById('getIdUnitId').value.trim();
            const ownerId = document.getElementById('getIdOwnerId').value.trim();

            if (!validateIdentityForm()) return;

            const spinner = document.getElementById('getIdentitySpinner');
            spinner.style.display = 'inline-block';

            fetch(`/identity?unitId=${encodeURIComponent(unitId)}&ownerId=${encodeURIComponent(ownerId)}`, {
                headers: {
                    'X-Session-Token': sessionToken
                }
            })
            .then(response => response.json())
            .then(result => {
                showResponse('identity', result);
                if (result.qrCode) {
                    showToast('Identity retrieved successfully!', 'success');
                } else {
                    showToast('Error retrieving identity: ' + (result.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showToast('Network error: ' + error.message, 'error');
            })
            .finally(() => {
                spinner.style.display = 'none';
            });
        }

        function handleGetVisitorQR(e) {
            e.preventDefault();
            
            const unitId = document.getElementById('getVisitorUnitId').value.trim();
            const ownerId = document.getElementById('getVisitorOwnerId').value.trim();
            const visitorName = document.getElementById('getVisitorName').value.trim();
            const visitDate = document.getElementById('getVisitorDate').value;

            if (!validateVisitorForm()) return;

            const spinner = document.getElementById('getVisitorSpinner');
            spinner.style.display = 'inline-block';

            fetch(`/visitor-qr?unitId=${encodeURIComponent(unitId)}&ownerId=${encodeURIComponent(ownerId)}&visitorName=${encodeURIComponent(visitorName)}&visitDate=${encodeURIComponent(visitDate)}`, {
                headers: {
                    'X-Session-Token': sessionToken
                }
            })
            .then(response => response.json())
            .then(result => {
                showResponse('visitor', result);
                if (result.qrCode) {
                    showToast('Visitor QR generated successfully!', 'success');
                } else {
                    showToast('Error generating visitor QR: ' + (result.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showToast('Network error: ' + error.message, 'error');
            })
            .finally(() => {
                spinner.style.display = 'none';
            });
        }

        function handleDeleteResident(e) {
            e.preventDefault();
            
            const ownerId = document.getElementById('deleteOwnerId').value.trim();

            if (!validateDeleteForm()) return;

            if (!confirm(`Are you sure you want to delete resident ${ownerId}? This will soft-delete them (mark as deleted).`)) {
                return;
            }

            const spinner = document.getElementById('deleteSpinner');
            spinner.style.display = 'inline-block';

            fetch(`/residents?ownerId=${encodeURIComponent(ownerId)}`, {
                method: 'DELETE',
                headers: {
                    'X-Session-Token': sessionToken
                }
            })
            .then(response => response.json())
            .then(result => {
                showResponse('delete', result);
                if (result.success) {
                    showToast('Resident deleted successfully!', 'success');
                    loadResidents();
                } else {
                    showToast('Error deleting resident: ' + (result.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showToast('Network error: ' + error.message, 'error');
            })
            .finally(() => {
                spinner.style.display = 'none';
            });
        }

        // Configuration Functions
        function loadConfig() {
            fetch('/admin/config', {
                headers: {
                    'X-Session-Token': sessionToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tbody = document.getElementById('configTableBody');
                    tbody.innerHTML = '';
                    
                    Object.entries(data.config).forEach(([key, config]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${key}</td>
                            <td><input type="text" value="${config.value}" style="width: 200px; padding: 5px;"></td>
                            <td>${config.type}</td>
                            <td>${config.description}</td>
                            <td>${config.updated_at}</td>
                            <td><button class="btn btn-small" onclick="updateConfig('${key}', this)">Update</button></td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    document.getElementById('configList').style.display = 'block';
                    showToast('Configuration loaded successfully', 'success');
                } else {
                    showResponse('config', data);
                    showToast('Error loading configuration', 'error');
                }
            })
            .catch(error => {
                showToast('Network error: ' + error.message, 'error');
            });
        }

        function updateConfig(key, button) {
            const row = button.closest('tr');
            const value = row.querySelector('input').value;
            
            fetch('/admin/config', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Session-Token': sessionToken
                },
                body: JSON.stringify({ key, value })
            })
            .then(response => response.json())
            .then(result => {
                showResponse('config', result);
                if (result.success) {
                    showToast('Configuration updated successfully', 'success');
                } else {
                    showToast('Error updating configuration', 'error');
                }
            })
            .catch(error => {
                showToast('Network error: ' + error.message, 'error');
            });
        }

        function changePassword() {
            const currentPassword = prompt('Enter current password:');
            if (!currentPassword) return;
            
            const newPassword = prompt('Enter new password:');
            if (!newPassword || newPassword.length < 8) {
                alert('Password must be at least 8 characters long');
                return;
            }
            
            const confirmPassword = prompt('Confirm new password:');
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            fetch('/admin/password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Session-Token': sessionToken
                },
                body: JSON.stringify({
                    currentPassword,
                    newPassword,
                    confirmPassword
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast('Password changed successfully', 'success');
                } else {
                    showToast('Error changing password: ' + result.error, 'error');
                }
            })
            .catch(error => {
                showToast('Network error: ' + error.message, 'error');
            });
        }

        // Logs Functions
        function loadLogs() {
            const limit = document.getElementById('logsLimit').value;
            
            fetch(`/admin/logs?limit=${limit}`, {
                headers: {
                    'X-Session-Token': sessionToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tbody = document.getElementById('logsTableBody');
                    tbody.innerHTML = '';
                    
                    data.logs.forEach(log => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${log.timestamp}</td>
                            <td>${log.method}</td>
                            <td>${log.url}</td>
                            <td>${log.statusCode}</td>
                            <td>${log.responseTime}ms</td>
                            <td>${log.ip}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    document.getElementById('logsList').style.display = 'block';
                    showToast('Logs loaded successfully', 'success');
                } else {
                    showResponse('logs', data);
                    showToast('Error loading logs', 'error');
                }
            })
            .catch(error => {
                showToast('Network error: ' + error.message, 'error');
            });
        }

        function clearLogs() {
            if (confirm('Are you sure you want to clear all logs?')) {
                fetch('/admin/logs/clear', {
                    method: 'POST',
                    headers: {
                        'X-Session-Token': sessionToken
                    }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showToast('Logs cleared successfully', 'success');
                        document.getElementById('logsList').style.display = 'none';
                    } else {
                        showToast('Error clearing logs', 'error');
                    }
                })
                .catch(error => {
                    showToast('Network error: ' + error.message, 'error');
                });
            }
        }

        // Utility Functions
        function validateCreateForm() {
            let isValid = true;
            const name = document.getElementById('createName').value.trim();
            const email = document.getElementById('createEmail').value.trim();
            const community = document.getElementById('createCommunity').value.trim();
            const unitId = document.getElementById('createUnitId').value.trim();
            const from = document.getElementById('createFrom').value;
            const to = document.getElementById('createTo').value;

            // Name validation
            if (!name || name.length < 2) {
                showError('nameError', 'Name must be at least 2 characters long');
                isValid = false;
            } else {
                hideError('nameError');
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email || !emailRegex.test(email)) {
                showError('emailError', 'Please enter a valid email address');
                isValid = false;
            } else {
                hideError('emailError');
            }

            // Community validation
            if (!community) {
                showError('communityError', 'Community is required');
                isValid = false;
            } else {
                hideError('communityError');
            }

            // Unit ID validation
            if (!unitId) {
                showError('unitIdError', 'Unit ID is required');
                isValid = false;
            } else {
                hideError('unitIdError');
            }

            // Date validation
            if (!from) {
                showError('fromError', 'Start date is required');
                isValid = false;
            } else {
                hideError('fromError');
            }

            if (!to) {
                showError('toError', 'End date is required');
                isValid = false;
            } else {
                hideError('toError');
            }

            if (from && to && new Date(from) >= new Date(to)) {
                showError('toError', 'End date must be after start date');
                isValid = false;
            } else {
                hideError('toError');
            }

            return isValid;
        }

        function validateIdentityForm() {
            let isValid = true;
            const ownerId = document.getElementById('getIdOwnerId').value.trim();

            if (!ownerId) {
                showError('getIdOwnerIdError', 'Owner ID is required');
                isValid = false;
            } else {
                hideError('getIdOwnerIdError');
            }

            return isValid;
        }

        function validateVisitorForm() {
            let isValid = true;
            const ownerId = document.getElementById('getVisitorOwnerId').value.trim();
            const unitId = document.getElementById('getVisitorUnitId').value.trim();
            const visitorName = document.getElementById('getVisitorName').value.trim();
            const visitDate = document.getElementById('getVisitorDate').value;

            if (!ownerId) {
                showError('getVisitorOwnerIdError', 'Owner ID is required');
                isValid = false;
            } else {
                hideError('getVisitorOwnerIdError');
            }

            if (!unitId) {
                showError('getVisitorUnitIdError', 'Unit ID is required');
                isValid = false;
            } else {
                hideError('getVisitorUnitIdError');
            }

            if (!visitorName || visitorName.length < 2) {
                showError('getVisitorNameError', 'Visitor name must be at least 2 characters long');
                isValid = false;
            } else {
                hideError('getVisitorNameError');
            }

            if (!visitDate) {
                showError('getVisitorDateError', 'Visit date is required');
                isValid = false;
            } else {
                hideError('getVisitorDateError');
            }

            return isValid;
        }

        function validateDeleteForm() {
            let isValid = true;
            const ownerId = document.getElementById('deleteOwnerId').value.trim();

            if (!ownerId) {
                showError('deleteOwnerIdError', 'Owner ID is required');
                isValid = false;
            } else {
                hideError('deleteOwnerIdError');
            }

            return isValid;
        }

        function showError(errorId, message) {
            const errorElement = document.getElementById(errorId);
            const inputElement = errorElement.parentElement.querySelector('input, select');
            
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            inputElement.classList.add('field-error');
        }

        function hideError(errorId) {
            const errorElement = document.getElementById(errorId);
            const inputElement = errorElement.parentElement.querySelector('input, select');
            
            errorElement.style.display = 'none';
            inputElement.classList.remove('field-error');
        }

        function showResponse(operation, data) {
            const container = document.getElementById(operation + 'ResponseContainer');
            const body = document.getElementById(operation + 'ResponseBody');
            
            container.style.display = 'block';
            body.innerHTML = formatJsonResponse(data);
        }

        function formatJsonResponse(obj) {
            try {
                const jsonString = JSON.stringify(obj, null, 2);
                return jsonString
                    .replace(/&/g, '&')
                    .replace(/</g, '<')
                    .replace(/>/g, '>')
                    .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                        var cls = 'json-number';
                        if (/^"/.test(match)) {
                            if (/:$/.test(match)) {
                                cls = 'json-key';
                            } else {
                                cls = 'json-string';
                            }
                        } else if (/true|false/.test(match)) {
                            cls = 'json-boolean';
                        } else if (/null/.test(match)) {
                            cls = 'json-null';
                        }
                        return '<span class="' + cls + '">' + match + '</span>';
                    });
            } catch (e) {
                return obj.toString();
            }
        }

        function copyResponse(operation) {
            const body = document.getElementById(operation + 'ResponseBody');
            const text = body.innerText;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Response copied to clipboard', 'success');
            }).catch(err => {
                showToast('Failed to copy: ' + err, 'error');
            });
        }

        function clearResponse(operation) {
            const container = document.getElementById(operation + 'ResponseContainer');
            const body = document.getElementById(operation + 'ResponseBody');
            
            container.style.display = 'none';
            body.innerHTML = '';
        }

        function showToast(message, type) {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            
            const icon = document.createElement('span');
            icon.className = 'toast-icon';
            icon.innerHTML = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            
            const text = document.createElement('span');
            text.textContent = message;
            
            toast.appendChild(icon);
            toast.appendChild(text);
            toastContainer.appendChild(toast);
            
            // Trigger show animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        function viewDetails(ownerId) {
            // This would show a modal with resident details
            alert('View details for resident: ' + ownerId);
        }
    </script>
</body>
</html>
